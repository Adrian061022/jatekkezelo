<div class="details-container">
  <div class="container">
    <!-- Loading -->
    <div *ngIf="isLoading" class="loading">
      <div class="spinner"></div>
      <p>Loading game details...</p>
    </div>

    <!-- Error -->
    <div *ngIf="errorMessage && !isLoading" class="error-state">
      <div class="error-icon">‚ùå</div>
      <h2>{{ errorMessage }}</h2>
      <button (click)="goBack()" class="btn btn-secondary">
        ‚Üê Back to Games
      </button>
    </div>

    <!-- Game Details -->
    <div *ngIf="game && !isLoading" class="game-details">
      <button (click)="goBack()" class="btn-back">
        ‚Üê Back to Games
      </button>

      <div class="details-grid">
        <div class="game-image-section">
          <img 
            [src]="game.cover_image || 'https://via.placeholder.com/600x280/1a1a2e/16213e?text=No+Image'" 
            [alt]="game.title"
            class="game-cover"
          />
        </div>

        <div class="game-info-section">
          <div class="game-header">
            <div>
              <span class="game-category">{{ game.category.name }}</span>
              <h1 class="game-title">{{ game.title }}</h1>
            </div>
            <div class="game-price">${{ game.price }}</div>
          </div>

          <div class="game-description">
            <h3>About This Game</h3>
            <p>{{ game.description }}</p>
          </div>

          <div class="game-meta">
            <div class="meta-item">
              <span class="meta-label">Category</span>
              <span class="meta-value">{{ game.category.name }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Release Date</span>
              <span class="meta-value">{{ game.created_at | date:'mediumDate' }}</span>
            </div>
          </div>

          <!-- Success/Error Messages -->
          <div *ngIf="successMessage" class="alert alert-success">
            {{ successMessage }}
          </div>
          <div *ngIf="errorMessage && !isLoading" class="alert alert-error">
            {{ errorMessage }}
          </div>

          <!-- User Actions -->
          <div *ngIf="authService.isLoggedIn && !isAdmin" class="user-actions">
            <button 
              *ngIf="!ownsGame && !checkingOwnership" 
              (click)="purchaseGame()" 
              class="btn btn-purchase">
              üõí Purchase for ${{ game.price }}
            </button>
            <div *ngIf="ownsGame" class="owned-badge">
              ‚úÖ You own this game
            </div>
          </div>

          <!-- Admin Actions -->
          <div *ngIf="isAdmin" class="admin-actions">
            <button (click)="editGame()" class="btn btn-primary">
              ‚úèÔ∏è Edit Game
            </button>
            <button (click)="deleteGame()" class="btn btn-danger">
              üóëÔ∏è Delete Game
            </button>
          </div>
        </div>
      </div>

      <!-- Reviews Section -->
      <div class="reviews-section">
        <div class="reviews-header">
          <h2>√ârt√©kel√©sek</h2>
          <div class="rating-summary" *ngIf="totalReviews > 0">
            <div class="average-rating">
              <span class="rating-number">{{ averageRating.toFixed(1) }}</span>
              <div class="stars">
                <span *ngFor="let filled of getStars(getRoundedRating())" 
                      [class.filled]="filled" 
                      class="star">‚òÖ</span>
              </div>
              <span class="review-count">{{ totalReviews }} √©rt√©kel√©s</span>
            </div>
          </div>
        </div>

        <!-- Write Review Form -->
        <div *ngIf="authService.isLoggedIn && !userReview" class="review-form">
          <h3>√çrd meg az √©rt√©kel√©sedet</h3>
          <form (ngSubmit)="submitReview()" #reviewForm="ngForm">
            <div class="rating-input">
              <label>√ârt√©kel√©s:</label>
              <div class="star-rating">
                <button 
                  type="button"
                  *ngFor="let star of [1,2,3,4,5]; let i = index" 
                  (click)="setRating(star)"
                  class="star-btn"
                  [class.active]="star <= reviewData.rating"
                >
                  ‚òÖ
                </button>
              </div>
            </div>

            <div class="comment-input">
              <label for="comment">V√©lem√©ny (opcion√°lis):</label>
              <textarea
                id="comment"
                name="comment"
                [(ngModel)]="reviewData.comment"
                rows="4"
                placeholder="Oszd meg a v√©lem√©nyedet a j√°t√©kr√≥l..."
              ></textarea>
            </div>

            <button type="submit" class="btn btn-primary" [disabled]="reviewData.rating === 0">
              <span>üìù</span> √ârt√©kel√©s k√∂zz√©t√©tele
            </button>
          </form>
        </div>

        <!-- Edit Review Form -->
        <div *ngIf="authService.isLoggedIn && userReview && isEditingReview" class="review-form">
          <h3>√ârt√©kel√©s szerkeszt√©se</h3>
          <form (ngSubmit)="submitReview()" #editReviewForm="ngForm">
            <div class="rating-input">
              <label>√ârt√©kel√©s:</label>
              <div class="star-rating">
                <button 
                  type="button"
                  *ngFor="let star of [1,2,3,4,5]; let i = index" 
                  (click)="setRating(star)"
                  class="star-btn"
                  [class.active]="star <= reviewData.rating"
                >
                  ‚òÖ
                </button>
              </div>
            </div>

            <div class="comment-input">
              <label for="edit-comment">V√©lem√©ny (opcion√°lis):</label>
              <textarea
                id="edit-comment"
                name="comment"
                [(ngModel)]="reviewData.comment"
                rows="4"
                placeholder="Oszd meg a v√©lem√©nyedet a j√°t√©kr√≥l..."
              ></textarea>
            </div>

            <div class="form-actions">
              <button type="button" (click)="cancelEditReview()" class="btn btn-secondary">
                <span>‚ùå</span> M√©gse
              </button>
              <button type="submit" class="btn btn-primary" [disabled]="reviewData.rating === 0">
                <span>üíæ</span> Ment√©s
              </button>
            </div>
          </form>
        </div>

        <!-- User's Review Display -->
        <div *ngIf="authService.isLoggedIn && userReview && !isEditingReview" class="user-review-display">
          <h3>Az √©rt√©kel√©sed</h3>
          <div class="review-card own-review">
            <div class="review-header">
              <div class="user-info">
                <img 
                  [src]="userReview.user.profile_picture || 'https://via.placeholder.com/48/1a1a2e/16213e?text=' + userReview.user.name.charAt(0)" 
                  [alt]="userReview.user.name"
                  class="user-avatar"
                  width="48"
                  height="48"
                />
                <div>
                  <span class="user-name">{{ userReview.user.name }} (Te)</span>
                  <div class="stars small">
                    <span *ngFor="let filled of getStars(userReview.rating)" 
                          [class.filled]="filled" 
                          class="star">‚òÖ</span>
                  </div>
                </div>
              </div>
              <div class="review-actions">
                <button (click)="isEditingReview = true" class="btn-icon edit">
                  Szerkeszt√©s
                </button>
                <button (click)="deleteReview(userReview.id)" class="btn-icon delete">
                  T√∂rl√©s
                </button>
              </div>
            </div>
            <p class="review-comment" *ngIf="userReview.comment">{{ userReview.comment }}</p>
            <p class="review-date">{{ userReview.created_at | date:'medium' }}</p>
          </div>
        </div>

        <!-- Reviews List -->
        <div class="reviews-list">
          <div *ngIf="loadingReviews" class="loading">
            <div class="spinner"></div>
            <p>√ârt√©kel√©sek bet√∂lt√©se...</p>
          </div>

          <div *ngIf="!loadingReviews && reviews.length === 0" class="no-reviews">
            <p>M√©g nincs √©rt√©kel√©s ehhez a j√°t√©khoz.</p>
            <p *ngIf="!authService.isLoggedIn">Jelentkezz be az els≈ë √©rt√©kel√©s √≠r√°s√°hoz!</p>
          </div>

          <div 
            *ngFor="let review of reviews" 
            class="review-card"
            [class.own-review]="review.user_id === authService.currentUserValue?.id"
          >
            <!-- Skip user's own review as it's displayed separately -->
            <ng-container *ngIf="review.user_id !== authService.currentUserValue?.id">
              <div class="review-header">
                <div class="user-info">
                  <img 
                    [src]="review.user.profile_picture || 'https://via.placeholder.com/48/1a1a2e/16213e?text=' + review.user.name.charAt(0)" 
                    [alt]="review.user.name"
                    class="user-avatar"
                    width="48"
                    height="48"
                  />
                  <div>
                    <a [routerLink]="['/user', review.user.id]" class="user-name-link">
                      <span class="user-name">{{ review.user.name }}</span>
                    </a>
                    <div class="stars small">
                      <span *ngFor="let filled of getStars(review.rating)" 
                            [class.filled]="filled" 
                            class="star">‚òÖ</span>
                    </div>
                  </div>
                </div>
                <button 
                  *ngIf="isAdmin"
                  (click)="deleteReview(review.id)" 
                  class="btn-icon delete"
                  title="√ârt√©kel√©s t√∂rl√©se (Admin)"
                >
                  T√∂rl√©s
                </button>
              </div>
              <p class="review-comment" *ngIf="review.comment">{{ review.comment }}</p>
              <p class="review-date">{{ review.created_at | date:'medium' }}</p>
            </ng-container>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
